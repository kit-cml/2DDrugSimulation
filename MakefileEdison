BLDIR = /SYSTEM
PETSC_DIR = $(BLDIR)/petsc-3.1-p5
PETSC_ARCH = linux-gnu-c-debug
PETSC_LIB = $(PETSC_DIR)/$(PETSC_ARCH)/lib
$(info PETSC_DIR="$(PETSC_DIR)"  )
include ${PETSC_DIR}/conf/variables
#PETSC_LIB = -Wl,-rpath,/opt/Lib/dev/petsc/lib -L/opt/Lib/dev/petsc/lib -lpetsc
#PETSC_LIB=-Wl,-rpath,/opt/Lib/dev/petsc/lib -L/opt/Lib/dev/petsc/lib -lpetsc -Wl,-rpath,/opt/Lib/dev/petsc/lib -L/opt/Lib/dev/petsc/lib -lf2clapack -lf2cblas -Wl,-rpath,/usr/local/lib -Wl,-rpath,/opt/Lib/dev/openmpi/lib -ldl /usr/local/lib64/libsundials_nvecserial.a /usr/local/lib64/libsundials_cvode.a 
LEX      = flex
YACC     = yacc
#CXXFLAGS = -fpermissive -std=c++11
CXXFLAGS = -fpermissive -DTISSUE -DVTK_COMBINED
LEXFLAGS =
YACCFLAGS= -d
INCPATH  = -I./ -I/ $(PETSC_DIR)/include 
LFLAGS   =  -pg
LIBS	=  $(PETSC_LIB) -lpetsc -lz -lm
PCC = /opt/mpi/intel/mpich-1.2.7p1/bin/mpicxx

AR       = ar cqs
RANLIB   =
TAR      = tar -cf
GZIP     = gzip -9f
COPY     = cp -f
COPY_FILE= $(COPY)
COPY_DIR = $(COPY) -r
INSTALL_FILE= $(COPY_FILE)
INSTALL_DIR = $(COPY_DIR)
DEL_FILE = rm -f
SYMLINK  = ln -sf
DEL_DIR  = rmdir
MOVE     = mv -f
CHK_DIR_EXISTS= test -d
MKDIR    = mkdir -p

####### Output directory

OBJECTS_DIR = ./

####### Files

HEADERS := fem.h \
	  heart_drug.h \
	  heart_tn2006.h \
	  mesh.h \
		fiber.h \
		bspm.h \
    ccalcexception.h \
    CEPCell_NEO/modules/globals.hpp \
    libs/ode.hpp \
    $(wildcard CEPCell_NEO/cellmodels/*.hpp)


SOURCES := bench3d.cpp \
	  fem.cpp \
	  heart_drug.cpp \
	  heart_tn2006.cpp \
	  mesh.cpp \
	  fiber.cpp \
    bspm.cpp \
    ccalcexception.cpp \
    CEPCell_NEO/modules/globals.cpp \
    libs/ode.cpp \
    $(wildcard CEPCell_NEO/cellmodels/*.cpp)

OBJECTS := $(SOURCES:%.cpp=%.o)

FORMS =
UICDECLS =
UICIMPLS =
SRCMOC   =
OBJMOC =
DESTDIR  = 
TARGET   = ./bin/CEP6_3D
#TARGET   = ./bin/CEP6_3D
#TARGET   = ./bin/CEP4_bspm

first: all
####### Implicit rules

.SUFFIXES: .c .o .cpp .cc .cxx .C

.cpp.o:
	$(PETSC_COMPILE_SINGLE) $(CXXFLAGS) $(INCPATH) -o $@ $<

.cc.o:
	$(PETSC_COMPILE_SINGLE) $(CXXFLAGS) $(INCPATH) -o $@ $<

.cxx.o:
	$(PETSC_COMPILE_SINGLE) $(CXXFLAGS) $(INCPATH) -o $@ $<

.C.o:
	$(PETSC_COMPILE_SINGLE) $(CXXFLAGS) $(INCPATH) -o $@ $<

.c.o:
	$(PETSC_COMPILE_SINGLE) $(CFLAGS) $(INCPATH) -o $@ $<

####### Build rules

all: Makefile $(TARGET)

$(TARGET):  $(OBJECTS)
	cep2017_heart -d bin/ || mkdir -p ./bin
	$(info PCC="$(PCC)"  )
	$(info PETSC_LIB="$(PETSC_LIB)")
	$(PCC) $(LFLAGS) -o $(TARGET) $(OBJECTS) $(OBJCOMP) $(LIBS)

dist:
	@mkdir -p .tmp/two && $(COPY_FILE) --parents $(SOURCES) $(HEADERS) $(FORMS) $(DIST) .tmp/two/ && ( cd `dirname .tmp/two` && $(TAR) two.tar two && $(GZIP) two.tar ) && $\(MOVE) `dirname .tmp/two`/two.tar.gz . && $(DEL_FILE) -r .tmp/two


clean:
	-$(DEL_FILE) -f *.o
	-$(DEL_FILE) -f CEPCell_NEO/*.o
	-$(DEL_FILE) -f CEPCell_NEO/**/*.o
	-$(DEL_FILE) *~ core *.core
	-$(DEL_FILE) -f *.out
	-$(DEL_FILE) $(TARGET)
